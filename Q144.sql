CREATE TABLE DETAILED_OOS_EVENTS (
    MASTER_ID VARCHAR(10),
    MARKETPLACE_ID INT,
    OOS_DATE DATE
);
INSERT INTO DETAILED_OOS_EVENTS VALUES
('P04G', 13, '2023-07-03'),
('P04G', 13, '2023-07-04'),
('P04G', 13, '2024-06-30'),
('P04G', 13, '2024-07-01'),
('P04G', 13, '2024-07-02'),
('P04G', 13, '2024-07-03'),
('P04G', 13, '2024-07-04'),
('P04G', 13, '2024-07-05'),
('P04G', 13, '2024-07-06'),
('P04G', 13, '2024-07-07'),
('P04G', 13, '2024-07-08'),
('P04G', 13, '2024-07-09');

WITH cte AS (
SELECT MASTER_ID, MARKETPLACE_ID, OOS_DATE,
LAG(OOS_DATE) OVER (PARTITION BY MASTER_ID, MARKETPLACE_ID ORDER BY OOS_DATE) AS prev_date
FROM DETAILED_OOS_EVENTS
)
SELECT MASTER_ID, MARKETPLACE_ID,OOS_DATE
FROM cte
WHERE prev_date IS NULL OR DATEDIFF(OOS_DATE, prev_date) >= 7
ORDER BY MASTER_ID, MARKETPLACE_ID, OOS_DATE;